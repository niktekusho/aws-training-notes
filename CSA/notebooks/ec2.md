# AWS Elastic Compute Cloud

AWS is a way to run virtual servers in the cloud.

In AWS data centers, an EC2 host can run multiple EC2 instances using server virtualization.

EC2 hosts are managed by AWS.

User manages EC2 instances.

An EC2 instance is a virtual server with a specific amount of cores, memory, storage and network capabilities and a choice of OS (Linux, Windows and macOS). On top of the OS you install applications.

An instance type is a template of the server which specifies available resources (cores, memory, etc.).
The instance type defines the hardware profile and the cost.

Launch EC2 instance interactively:

1. Login to AWS Management Console
2. "launch an EC2 instance"
3. Select the instance type
4. Choose an Amazon Machine Image (AMI)

AMI = OS + basic config = configuration of an EC2 instance

AMI is created from an EBS snapshot.

EBS snapshot = point in time backup of an instance.

EBS = Elastic Block Store volume = Virtual storage

AMIs can be created by the user with the customization they want.

EC2 instance types

| Family            | Type       | vCPUs | Memory (GB) |
| ----------------- | ---------- | ----- | ----------- |
| General Purpose   | t2.micro   | 1     | 1           |
| Compute Optimized | c5n.large  | 2     | 5,25        |
| Memory Optimized  | r5ad.large | 2     | 16          |
| Storage Optimized | d2.xlarge  | 4     | 30,5        |
| GPU instances     | g2.2xlarge | 8     | 15          |

Benefits of EC2:

- elastic computing = launch hundreds of EC2 instances within minutes
- complete control = instance creator has root access to the virtual server
- flexible = instance creator can choose instance types, OS and installed software
- reliable = high availability and instances can be replaced quickly when failure occurs
- secure = integrated in AWS VPC
- inexpensive = pay per use and/or low cost

VPC = Virtual Private Cloud = User's virtual data center 

EC2 instance in Public Subnet = can connect to the instance with an internet connection.

EC2 hierarcy (?):

Region -> VPC -> Availability zone -> Public/Private Subnet -> EC2 instances

EC2 instances can have a security group.
Security Group = Firewall = Ports + Protocols + IP Addresses that can connect to an EC2 instance.
Security Group controls inbound and outbound traffic.

Internet Gateway enables access from/to the internet and is attached to the VPC.

EC2 admin user -> Internet Gateway -> EC2 instance

## EC2 Launch Wizard

*Is this needed?

## EC2 User Data

It's a mechanism used to run code/commands when the instance starts for the first time.

Passed code is limited to 16 KB!

Linux instances can use bash/posix sh scripts.
Windows instances can use "batch" and PowerShell scripts.

## EC2 Metadata

EC2 Metadata = info about a specific EC2 instance.

Available in the EC2 instance at: http://169.254.169.254/latest/meta-data (local to the machine, does not connect to the internet)

Example output:

```sh
$ curl http://169.254.169.254/latest/meta-data
ami-id
ami-launch-index
...
hostname
...
instance-id
...
instance-type
...
local-hostname
local-ipv4
...


$ curl http://169.254.169.254/latest/meta-data/local-ipv4
172.31.42.248


```


## Accessing Services with Access Keys and IAM Roles

### Access Keys

- Access Keys allow an EC2 instance to connect to an other service securely.
- Access Keys are generated by a IAM User.
- Access Key uses permissions assigned to the user via policies.
- EC2 instance can then use the Access Keys. 
- Major drawback: Access Keys are stored on the instance file system in plaintext!!! File is `~/.aws/credentials`!


### IAM Roles

- Instance profile: way to connect an IAM Role to a specific EC2 instance.
- EC2 instance has a IAM Role attached to it.
- EC2 instance "AssumeRole"s the specified IAM Role.
- EC2 instance gains access to resources based on the permissions defined in the policy attached to the Role.
- NO CREDENTIALS STORED ON THE EC2 INSTANCE!

## EC2 Instances status and monitoring

2 types of status checks:

- System Status Checks = AWS checks the underlying hardware of the EC2 instance. If something is wrong, AWS Customer Support needs to be involved.
- Instance Status Checks = AWS checks the software and networking configuration of the EC2 instance. If something is wrong, the "user" needs to be involved.

EC2 monitors:

- CPU utilization (%)
- Total Status Checks failed (count)
- System Status Checks failed (count)
- Instance Status Checks failed (count)
- Network inbound traffic (Bytes)
- Network outbound traffic (Bytes)
- Network packets inbound (count)
- Network packets outbound (count)
- Disk reads (Bytes)
- Disk read Operations (op/s)
- Disk writes (Bytes)
- Disk write Operations (op/s)
- CPU Credit Usage (count)
- CPU Credit Balance (count)

All the previous data goes through AWS CloudWatch.
CloudWatch = Performance Monitoring tool

Basic monitoring (free): EC2 instance sends data to CloudWatch every 5 minutes.
Detailed monitoring (paid): EC2 instance sends data to CloudWatch every 1 minute.

## EC2 Placement Groups

Mechanism that allows you to control where AWS deploys EC2 instances in Availability Zones or across them.

Availability Zone ~= Datacenter

Placement groups options:

1. Cluster Placement Group = instances will be deployed close together inside an Availability Zone (example same rack).
  - Low Latency
  - High network throughput
  - Inside a single Availability Zone
  - Best used for thightly-coupled services (HPC applications) that interact among them a lot
2. Partition Placement Group = instances will be deployed across logical partitions such that groups of instances in one partition do not share hardware with groups of instances in different partitions.
   - Inside a single Availability Zone (at least different racks) or across multiple AZs
   - Max 7 partitions per Availability Zone
   - Best used for distributed and replicated workloads (Hadoop, Cassandra, Kafka) (separate hardware for node groups)
3. Spread Placement Group = each individual instance will be deployed across distinct underlying hardware.
   - Each instance is deployed on a separate rack
   - Reduces correlated failures
   - Best used for small number of critical instances that must be kept separate

To create a Placement Group you need to specify:

1. name of the Placement Group
2. type of the Placement Group

You can create Placement Groups while creating a new EC2 instance.

## Network Interfaces

Every network interface will have a private IP address.
Network interfaces may have public IP addresses (when explicitly configured).

Network interfaces are attached to a subnet within an Availability Zone. The EC2 instance is NOT in the subnet!
EC2 instances can be attached to multiple subnets through different adapters.

(?)Private network subnets needs to be located in the same Availability Zone of the EC2 instance.

3 types of network interface adapters:

- ENI = Elastic Network Interface
- ENA = Elastic Network Adapter
- EFA = Elastic Fabric Adapter

EC2 instance can only attach ENIs connected to subnets in the same Availability Zone.
ENIs cannot be attached to instances in a different AZ.

| Elastic Network Interface               | Elastic Network Adapter                       | Elastic Fabric Adapter                                                                                                |
| --------------------------------------- | --------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- |
| Basic Adapter                           | Enhanced networking performance               | Specialized network use cases                                                                                         |
| Can be used with all EC2 Instance Types | Can be used only on supported Instance Types  | Can be used with all EC2 Instance Types                                                                               |
| Medium/Low network performance          | High bandwidth and low inter-instance latency | Low latency                                                                                                           |
|                                         |                                               | Best used for HPC, MPI and ML workloads, where applications are thightly couped and have a lot of intercommunication. |

MPI = Message Passing Interface = (?)


### Types of IP addresses

1. Public IP address = dynamic address (changes when restarting an EC2 instance), used in public subnets, free, associated with a private IP address on the instance, cannot be moved between instances
2. Private IP address = static address (does not change when restarting EC2 instance), used in public and private subnets
3. Elastic IP address = public static address, paid when not used, associated with a private IP address on the instance, can be moved between instances and ENA

Stopped EC2 instances do not have a public IP address!
Rebooted EC2 instances do keep the public IP address!

Elastic IPs can be assigned to network interfaces.
Both ENIs and EIPs can be remapped to different EC2 instances.
EIPs can be remapped across AZs.
Elastic IPs are region "specific".

Elastic IPs use cases: increase fault tolerance of applications running on EC2

- Given an EC2 instance connected to a public subnet via an ENI associated with an EIP
- When EC2 instance fails
- Then create a new EC2 instance of the applicaton, detach the ENI from the failing EC2 instance, attach the ENI to the new EC2 instance
- Clients will continue to work!

- Given an EC2 instance in AZ 1 connected to a public subnet via an ENI associated with an EIP
- Given an "equal" EC2 instance in AZ 2 connected to a public subnet via an ENI associated WITHOUT an EIP
- When EC2 instance in AZ 1 fails
- Then move the EIP from EC2 instance in AZ 1 to instance in AZ 2
- Clients will continue to work!

NAT = Network Address Translation

EC2 instances can only access the private IP address. The public/Elastic IP addresses are not stored on the instances!
Public/Elastic addresses are ASSOCIATED with the private IP of the network adapter.

Internet Gateway performs 1:1 NAT from public IP to private IP and viceversa.

Network communication flow for outbound communications:

1. EC2 instance wants to send a packet to a client
2. Network adapter of the EC2 instance writes the packet with "Src" = private IP address and "Dest" = IP address of the client
3. Internet Gateway replaces "Src" with the public/Elastic IP address

Network communication flow for inbound communications:

1. Packet arrives from a client to the Internet Gateway with "Src" = IP address of the client and "Dest" = public/Elastic IP address
2. Internet Gateway replaces "Dest" with the private IP address

### Subnets

Region -> VPC -> Availability Zone -> Public subnet

Public subnet has a route table that allows internet access.
Public subnets assign EC2 instances public IPs automatically.

Route table:

| Destination (CIDR block)   | Target | Notes                                                                                                                                                                        |
| ------------- | ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 172.31.0.0/16 | local  | Any address block in the VPC will be in the specified range. If 2 instances are in this subnet they can communicate locally. VPC router routes requests inside the same VPC. |
| 0.0.0.0/0     | igw-id | Any other address not covered by the local route, route the request to the Internet Gateway. |



Private subnet has a separate route table WITHOUT internet access.
Private subnets cannot be attached to an Internet Gateway.

Subnets are created private by default.

It's possible to communicate between private and public subnets by using the same local CIDR block!

Subnets configuration isn't affected by Availability Zones.

Bastion Host = EC2 instance accessible from the internet that connects to another EC2 instance NOT accessible from the internet.

### NAT

NAT Gateways and NAT Instances are used to enable EC2 instances deployed in private subnets to connect to the internet (outbound only).

Used for:

- connecting to a service located to the internet
- download software and software updates

NAT Gateways should be deployed on public subnets to obtain public/Elastic IP addresses.

Private route table:

| Destination (CIDR block) | Target         |
| ------------------------ | -------------- |
| 10.0.0.0/16              | local          |
| 0.0.0.0/0                | nat-gateway-id |

NAT gateway is added to the private route table and every address not in the CIDR block of local connects to the internet.


NAT Instances = EC2 Instance configured to do what NAT Gateways do. Replaced by NAT Gateways.

NAT Instances use a special AMI `amzn-ami-vpc-nat`.
NAT Instances must disable source and destination checks to allow the translation of addresses!

#### NAT instances vs NAT gateways

- NAT instances are managed by the customer (OS updates, etc), NAT gateways by AWS
- NAT instances scale up manually (instance types) and use EC2 networking, NAT gateways provide elastic scaling up to 45 Gbps
- NAT instances do not have HA (can be done manually), NAT gateways have automatic HA inside an Availability Zone and can be created across zones
- NAT instances need to use Security Groups, NAT gateways do not (allow outbound access only)
- NAT instances can be used as Bastion Host, NAT gateways can not be accessed via SSH
- NAT instances can use Elastic IPs or public IPs, NAT gateways can only use Elastic IPs defined at creation time
- NAT instances can implement port forwarding manually, NAT gateways can not  

## EC2 Instance Lifecycle

1. EC2 launch instance from AMI -> **`Pending`**
2. Once the instance is ready -> **`Running`**
   1. When an instance is **`Running`** it can be _rebooted_. -> **`Rebooting`**
      After the reboot the instance should be **`Running`**
   2. When an instance is **`Running`** it can be _terminated_ -> **`Shutting Down`** -> **`Terminated`**
   3. When an instance is **`Running`** it can be _stopped_ -> **`Stopping`** -> **`Stopped`**
3. When an instance is **`Stopped`** it can be _terminated_ -> **`Terminated`**
4. When an instance is **`Stopped`** it can be _started_ again -> **`Pending`**

### Stopped instances

- Only EBS-backed instances can be stopped/hibernated! NO instance volumes!
- Stopped instances do not cost money.
- EBS volumes attached to a stopped instance can cost money.
- Data in RAM is lost
- Instance is migrated to a different host -> can be used to avoid downtime if the customer knows about a scheduled hardware maintainance
- Private IPs are retained
- Public IPs are released
- Elastic IPs are retained

### Hibernated instances

- Only on-demand or reserved Linux instances configured to be hibernated **on launch**
- RAM data is stored in a EBS volume
- After hibernation, EBS root volume is restored to its snapshot, RAM contents are restored, previously running processes are resumed, previously attached volumes are attached with the same id

### Rebooted instances

- Same as OS reboot
- DNS name and all IPs retained
- Does not cost money

### Retiring instances

AWS *retires* EC2 instances when:

- AWS detects irreparable failure of host's hardware
- instance reaches its scheduled retirement date

### Terminated instances

- Same as "delete" instance
- Cannot be recovered
- EBS root volumes are deleted by default

### Recovering instances

- CloudWatch can monitor system status checks and signal recovers when needed
- Usually caused by underlying platform issues
- Recovered instance is identical to original instance

## Nitro instances and enclaves

Nitro = next gen hardware platform for EC2 instances

- Supports both virtualized instances and bare-metal instances
- Nitro aims to provide best performance for instances impaired by virtualization costs
- Each function is a specialized hardware managed by the Nitro Hypervisor
  - Nitro "cards" for VPC
  - Nitro "cards" for EBS
  - Nitro for instance storage
  - Nitro card controller
  - Nitro security chip
  - Nitro Hypervisor
  - Nitro Enclaves
- Nitro provides close-to-metal performance even for virtualized instances
- Nitro powers Elastic Network and Fabric Adapters
- Nitro achieves higher network performance (100 Gbps)
- Nitro platform is optimized for HPC 
- Nitro provides up to 60 TB storage instances

Nitro enclaves provide isolated computing environments:
- runs on isolated/hardened VMs
- does not have persistent storage, interactive access and external networking
- uses cryptographic attestation to ensure only authorized code is running
- integrates with AWS Key Management Service (KMS)

Nitro enclaves should be used to protect and securely process very sensitive data:
- Personal Identifiable Information (PII)
- Healthcare data
- Financial data
- Intellectual Property data

## EC2 Pricing

EBS volumes are billed per second with a minimum of 1 minute.
Billed per hour with a minimum of 1 hour for Windows and commercial Linux distro (ex RedHat EL).

### On-demand Instances

Customers pay a standard price, without discount.
Customers have no commitment (leave when you want).

Good for dev/test environments and/or short-term or unpredictable workloads.

Billed per second with a minimum of 1 minute for Windows, Amazon Linux and Ubuntu instances.

### Reserved Instances

Customers pay a discounted price within the time of commitment (1 or 3 years).
Good for production/stable environments or predictable workloads.

Customers can pay:

- all upfront (max discount),
- partial upfront (upfront amount + monthly payment)
- no upfront (min discount, payments occured monthly)

Billed per second with a minimum of 1 minute for Windows, Amazon Linux and Ubuntu instances.

Discount is applied when the **attributes** of an instance **match the attrbiutes of a Reserved Instance** .
Considered attributes are:

- Instance family (a1. m4. etc)
- Instance OS
- Tenancy (default or dedicated)
- Availability Zones (including capacity reserve)
- Region (excluding capacity reserve)

2 types of Reserved Instances (RI):

- **Standard RI**: instance can change AZ, instance size (only Linux) and networking type (API `EC2:ModifyReservedInstances`)
- **Convertible RI**: instance can change AZ, instance size (only Linux), networking type, *instance family*, *tenancy* and *payment option* (API `EC2:ExchangeReservedInstances`)


(Deprecated!) Scheduled Reserved Instances: an RI matches capacity reservation to recurring schedules (min 1200 hours per year).
Useful for services that needs to run periodically and can then terminate "safely" (ex. reporting app that runs 6 hours a day x 4 days a week = 1248 hours per year).


### Spot Instances

Customers pay a high discounted price for unused AWS capacity (up to 90%).
Spot Instances can be terminated by AWS at any time with a 2 minute notice when AWS need to allocate resources to other instances.
Good for workloads that have flexible start and end times (batch processing).

Billed per second with a minimum of 1 minute for Windows, Amazon Linux and Ubuntu instances.

3 types of deploy:

- Spot Instance: customer defines a single instance
- Spot Fleet: customer defines a target capacity and AWS launches and manages Spot Instances and On-demand Instances to meet that capacity
- EC2 Fleet: customer defines number of Spot/On-demand/Reserved instances and AWS launches and manages those instances with one SINGLE API call

(Deprecated!) Spot Block: Spot Instance with the requirement of running uninterrupted for a range of time (1 to 6 hours). Price can be 30/45% less than On-demand Instances.

### Dedicated Instances

Customers pay per instance.
Dedicated Instances run on dedicated hosts, isolated from instances of other AWS customers.

*Dedicated Instances run on the same host of instances executed by the same customer*

### Dedicated Hosts

Customers pay per host.
Dedicated Hosts Instances have access to the whole physical server.
Dedicated Hosts Instances give access to sockets, cores and host's ID to apps running on them.

Dedicated Hosts Instances can be configured to run specific instances on specific hosts (host affinity and targeted placement).

Could be used if licensing is released on specific hardware (socket, CPU cores, etc)

Dedicated Hosts Instances can add capacity using an allocation request.

### Savings Plans

Customers pay based on amount of usage per hour and have a commitment of 1 or 3 years.

2 subtypes:

- Compute Savings Plan: 1 or 3 years of commitment, usage commitment by hour of **Fargate, Lambda and EC2**. Valid on **every region, family, size, tenancy and OS of the instances**.
- EC2 Savings Plan: 1 or 3 years of commitment, usage commitment by hour of **EC2 ONLY**. Valid on **specific regions and families**, **any size, tenancy and OS of the instances**.

## Architecture Patterns

> Run short batch script to configure Amazon EC2 Linux intances after they are launched?

Custom AMI or user data of the EC2 instances.

> Thightly coupled HPC workload requires low-latency between nodes and optimum network performance?

Deploy EC2 instances in a cluster placement group in a single AZ and use Elastic Fabric Adapter.

> Critical app receives weekly bursts of traffic and must scale for short periods, which is the most cost-effective solution?

Use Reserved Instances for minimum workloads and then use Spot Instances for the bursts in traffic.

> Single instance app with static public IP, how do you remap the address in case of failures?

Attach an Elastic IP Address to the EC2 instance and remap that IP in case of failures.

> Fleet of EC2 instances run in private subnets across AZs. How do you provide a redundant path to the internet?

Deploy NAT gateways in the AZs and configure route tables accordingly.

> How to let devs administer EC2 instances in private subnets from SSH?

Deploy a bastion host in a public subnet and attach it to the private subnets.
Devs will use SSH to connect to the bastion host and inside the bastion host they will connect to the private instances.

> App uses multiple EC2 instances. How do you minimize hardware failures?

Deploy instances in a spread placement group.

> App requires enhanced networking capabilities.

Choose an instance type that supports enhanced networking abd ensure Elastic Network Adapter module is installed and configured in the instance OS.

> Instance needs minimum virtualization overhead/high bandwidth/?

Deploy a Nitro instance type.

